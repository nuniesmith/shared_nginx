# Per-subdomain reverse proxy for 7gram.xyz services
# HTTPS handled with self-signed fallback (ssl.conf); upgrade to Let's Encrypt automatically when available.

map $http_upgrade $connection_upgrade { default upgrade; '' close; }

# -----------------------------------------------------------------------------
# DASHBOARD (root domain)
# -----------------------------------------------------------------------------
# Root domain is handled in default.conf (HTTP redirect + nginx.7gram.xyz dashboard).
# The following servers are intentionally disabled to avoid conflicts.
# server {
#     listen 80;
#     server_name 7gram.xyz www.7gram.xyz;
#
#     # ACME challenge (when switching to Let's Encrypt)
#     location ^~ /.well-known/acme-challenge/ { root /var/www/certbot; allow all; }
#
#     location /health { access_log off; return 200 "healthy\n"; add_header Content-Type text/plain; }
#     return 301 https://$host$request_uri;
# }
#
# server {
#     listen 443 ssl;
#     http2 on;
#     server_name 7gram.xyz www.7gram.xyz;
#     include /etc/nginx/conf.d/ssl.conf;
#
#     root /usr/share/nginx/html;
#     index index.html;
#
#     location /health { access_log off; return 200 "healthy (https)\n"; add_header Content-Type text/plain; }
#
#     location / { try_files $uri $uri/ /index.html; }
# }

# -----------------------------------------------------------------------------
# FREDDY: Infrastructure/system
# -----------------------------------------------------------------------------
# Pi-hole (http)
server {
    listen 443 ssl; 
    http2 on;
    server_name pihole.7gram.xyz; 
    include /etc/nginx/conf.d/ssl.conf;
    set $upstream http://freddy.7gram.xyz:8080;
    location / {
        proxy_pass $upstream/;
        proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Home Assistant (http, websockets)
server {
    listen 443 ssl; 
    http2 on; 
    server_name home.7gram.xyz homeassistant.7gram.xyz; 
    include /etc/nginx/conf.d/ssl.conf;
    set $upstream http://freddy.7gram.xyz:8123;
    location / {
        proxy_pass $upstream/;
        proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade;
        proxy_buffering off;
    }
}

# Portainer (HTTPS upstream on 9443)
server {
    listen 443 ssl; 
    http2 on; 
    server_name portainer.7gram.xyz; 
    include /etc/nginx/conf.d/ssl.conf;
    set $upstream https://freddy.7gram.xyz:9443;
    location / {
        proxy_pass $upstream/;
        proxy_ssl_verify off; proxy_ssl_server_name on;  # self-signed upstream
        proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade;
    }
}

# Syncthing UI on Freddy (8384) - enable once exposed on host
# server {
#   listen 80; server_name sync.7gram.xyz freddy-sync.7gram.xyz; return 301 https://$host$request_uri; }
# server {
#   listen 443 ssl http2; server_name sync.7gram.xyz freddy-sync.7gram.xyz; include /etc/nginx/conf.d/ssl.conf;
#   set $upstream http://freddy.7gram.xyz:8384; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
# }

# -----------------------------------------------------------------------------
# SULLIVAN: Media and AI services
# -----------------------------------------------------------------------------
# Emby
server {
    listen 443 ssl; 
    http2 on; 
    server_name emby.7gram.xyz; 
    include /etc/nginx/conf.d/ssl.conf;
    set $upstream http://sullivan.7gram.xyz:8096;  # Emby HTTP
    location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_buffering off; proxy_read_timeout 300s; }
}

# Jellyfin (adjust port if using 8096)
server {
    listen 443 ssl; 
    http2 on; 
    server_name jellyfin.7gram.xyz; 
    include /etc/nginx/conf.d/ssl.conf;
    set $upstream http://sullivan.7gram.xyz:8097;  # Use 8096 if standard
    location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_buffering off; proxy_read_timeout 300s; }
}

# Plex
server {
    listen 443 ssl; 
    http2 on; 
    server_name plex.7gram.xyz; 
    include /etc/nginx/conf.d/ssl.conf;
    set $upstream http://sullivan.7gram.xyz:32400;
    location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_buffering off; proxy_read_timeout 300s; }
}

# Open WebUI (AI)
server {
    listen 443 ssl; 
    http2 on; 
    server_name ai.7gram.xyz chat.7gram.xyz; 
    include /etc/nginx/conf.d/ssl.conf;
    set $upstream http://sullivan.7gram.xyz:3001;
    location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade; }
}

# Ollama API
server {
    listen 443 ssl; 
    http2 on; 
    server_name ollama.7gram.xyz; 
    include /etc/nginx/conf.d/ssl.conf;
    set $upstream http://sullivan.7gram.xyz:11434;
    location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_read_timeout 300s; proxy_send_timeout 300s; }
}

# Audiobookshelf
server {
    listen 443 ssl; 
    http2 on; 
    server_name abs.7gram.xyz audiobooks.7gram.xyz; 
    include /etc/nginx/conf.d/ssl.conf;
    set $upstream http://sullivan.7gram.xyz:13378;
    location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
}

# Calibre & Calibre Web
server { listen 443 ssl; http2 on; server_name calibre.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:8082; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }
server { listen 443 ssl; http2 on; server_name calibreweb.7gram.xyz calibre-web.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:8084; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

# qBittorrent
server {
    listen 443 ssl; 
    http2 on; 
    server_name qbt.7gram.xyz qbittorrent.7gram.xyz; 
    include /etc/nginx/conf.d/ssl.conf;
    set $upstream http://sullivan.7gram.xyz:8080;
    location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
}

# Jackett
server { listen 443 ssl; http2 on; server_name jackett.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:9117; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

# Sonarr / Radarr / Lidarr
server { listen 443 ssl; http2 on; server_name sonarr.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:8989; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }
server { listen 443 ssl; http2 on; server_name radarr.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:7878; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }
server { listen 443 ssl; http2 on; server_name lidarr.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:8686; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

# Readarr (audio/books) - enable when running
server { listen 443 ssl; http2 on; server_name readarr-audio.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:8787; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }
server { listen 443 ssl; http2 on; server_name readarr-books.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:8585; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

# YouTube DL (ytdl_material)
server { listen 443 ssl; http2 on; server_name youtube.7gram.xyz ytdl.7gram.xyz youtube-dl.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:8998; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

# Duplicati
server { listen 443 ssl; http2 on; server_name duplicati.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:8200; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

# Mealie
server { listen 443 ssl; http2 on; server_name mealie.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:9925; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

# Grocy
server { listen 443 ssl; http2 on; server_name grocy.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:9283; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

# Syncthing (Sullivan) - UI default 8384
server { listen 443 ssl; http2 on; server_name sync.7gram.xyz sullivan-sync.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:8384; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

# Wiki.js (adjust port if needed)
server { listen 443 ssl; http2 on; server_name wiki.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:8090; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

# Nextcloud (if enabled in future)
server { listen 443 ssl; http2 on; server_name nc.7gram.xyz nextcloud.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:8086; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# Catch-all HTTPS (close connection for unknown hosts)
# -----------------------------------------------------------------------------
## Removed duplicate default_server; default is defined in default.conf

# Navidrome / Music
server { listen 443 ssl; http2 on; server_name music.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:4533; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade; } }

# Stable Diffusion
server { listen 443 ssl; http2 on; server_name sd.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:7860; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

# ComfyUI
server { listen 443 ssl; http2 on; server_name comfy.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:8188; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

# Whisper ASR (if exposed)
server { listen 443 ssl; http2 on; server_name whisper.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:9000; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

# Code Server (VS Code)
server { listen 443 ssl; http2 on; server_name code.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://sullivan.7gram.xyz:8443; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade; } }

# Authelia (placeholder, adjust port when added)
server { listen 443 ssl; http2 on; server_name auth.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://freddy.7gram.xyz:9091; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

# Grafana (optional)
server { listen 443 ssl; http2 on; server_name grafana.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://freddy.7gram.xyz:3000; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

# Prometheus (optional)
server { listen 443 ssl; http2 on; server_name prometheus.7gram.xyz; include /etc/nginx/conf.d/ssl.conf; set $upstream http://freddy.7gram.xyz:9090; location / { proxy_pass $upstream/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }
