# /etc/nginx/includes/auth.conf
# ENHANCED - Authelia Authentication with Service Classification

# Enable auth_request module
auth_request /auth;

# Set variables from Authelia auth response headers
auth_request_set $user $upstream_http_remote_user;
auth_request_set $groups $upstream_http_remote_groups;
auth_request_set $name $upstream_http_remote_name;
auth_request_set $email $upstream_http_remote_email;

# Set additional useful variables
auth_request_set $auth_status $upstream_status;
auth_request_set $auth_cookie $upstream_http_set_cookie;

# Pass authentication variables to backend applications
proxy_set_header Remote-User $user;
proxy_set_header Remote-Groups $groups;
proxy_set_header Remote-Name $name;
proxy_set_header Remote-Email $email;

# Additional headers for compatibility
proxy_set_header X-Remote-User $user;
proxy_set_header X-Remote-Groups $groups;
proxy_set_header X-Remote-Name $name;
proxy_set_header X-Remote-Email $email;
proxy_set_header X-Forwarded-User $user;

# Clear any existing Authorization header
proxy_set_header Authorization "";

# Handle cookies from Authelia
proxy_set_header Set-Cookie $auth_cookie;

# Security headers for auth
proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header X-Forwarded-Host $http_host;

# Service-aware auth bypass (using maps)
# Only apply auth if required by service type
set $auth_bypass 0;
if ($auth_required = 0) {
    set $auth_bypass 1;
}

# ================================================================