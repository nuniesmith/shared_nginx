# config/nginx/includes/cors_headers.conf
# ENHANCED - Unified CORS Headers Configuration

#=================================
# CORS ORIGIN VALIDATION
#=================================

# Initialize CORS variables
set $cors_origin "";
set $cors_credentials "";
set $cors_headers "";
set $cors_methods "";

# Validate origin against trusted domains
if ($http_origin ~* "^https?://(localhost|127\.0\.0\.1|(.*\.)?7gram\.xyz)(:[0-9]+)?$") {
    set $cors_origin $http_origin;
    set $cors_credentials "true";
    set $cors_headers "Accept,Accept-Language,Content-Language,Content-Type,Authorization,X-Requested-With,User-Agent,Cache-Control,Pragma";
    set $cors_methods "GET, HEAD, OPTIONS, POST, PUT, DELETE";
}

# Fallback to wildcard if no trusted origin matches
if ($cors_origin = "") {
    set $cors_origin "*";
    set $cors_credentials "false";
    set $cors_headers "Accept,Accept-Language,Content-Language,Content-Type,Authorization,X-Requested-With,User-Agent,Cache-Control,Pragma";
    set $cors_methods "GET, HEAD, OPTIONS, POST, PUT, DELETE";
}

#=================================
# SERVICE-SPECIFIC CORS MAPPINGS
#=================================

# Simplified CORS configuration
add_header Access-Control-Allow-Origin "*" always;
add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
add_header Access-Control-Max-Age 3600 always;
add_header Access-Control-Expose-Headers "Content-Length" always;

# Service-specific expose headers
add_header Access-Control-Expose-Headers $cors_expose_headers always;

#=================================
# PREFLIGHT REQUEST HANDLING
#=================================

# Handle OPTIONS preflight requests
if ($request_method = 'OPTIONS') {
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Methods $cors_methods always;
    add_header Access-Control-Allow-Headers $cors_headers always;
    add_header Access-Control-Max-Age 3600 always;
    
    # Only add credentials header for trusted origins
    if ($cors_origin != "*") {
        add_header Access-Control-Allow-Credentials $cors_credentials always;
    }
    
    add_header Content-Length 0;
    add_header Content-Type text/plain;
    return 204;
}